<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebAR 粒子互动系统</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script>
    // 通过异步加载脚本来确保顺序
    window.onload = async function() {
      // 加载 Three.js 库
      await loadScript('https://unpkg.com/three@0.132.2/build/three.min.js');
      
      // 加载 MediaPipe Hands 库
      await loadScript('https://unpkg.com/@mediapipe/hands@0.4.1659419535/hands.min.js');
      
      // 运行主程序
      init();
    };

    // 脚本加载函数
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // 初始化 Three.js 和 MediaPipe Hands
    function init() {
      // 创建场景、相机和渲染器
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // 创建粒子系统
      const particles = createParticles();
      scene.add(particles);

      // 添加光源
      const light = new THREE.AmbientLight(0x404040, 2); // 环境光
      scene.add(light);

      // 设置相机位置
      camera.position.z = 5;

      // 设置手势识别
      const hands = new Hands();
      hands.setOptions({
        maxNumHands: 2,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
      
      // 加载手势数据处理回调
      hands.onResults(onResults);

      // 创建一个 MediaPipe 摄像头视频流
      const videoElement = document.createElement('video');
      videoElement.width = 640;
      videoElement.height = 480;
      videoElement.style.display = 'none';  // 隐藏视频元素
      document.body.appendChild(videoElement);

      // 获取视频流并播放
      navigator.mediaDevices.getUserMedia({
        video: true
      }).then((stream) => {
        videoElement.srcObject = stream;
        videoElement.play();
        detectHands();
      }).catch(err => {
        console.error("无法访问摄像头: ", err);
      });

      // 开始手势检测
      function detectHands() {
        hands.send({image: videoElement});
        requestAnimationFrame(detectHands);
      }

      // 手势识别回调函数
      function onResults(results) {
        if (results.multiHandLandmarks) {
          results.multiHandLandmarks.forEach((landmarks) => {
            // 根据手势形状或位置改变粒子行为
            console.log("Hand landmarks detected:", landmarks);
          });
        }
      }

      // 渲染循环
      function animate() {
        requestAnimationFrame(animate);

        // 旋转粒子系统
        particles.rotation.x += 0.01;
        particles.rotation.y += 0.01;

        renderer.render(scene, camera);
      }

      animate();
    }

    // 创建粒子系统
    function createParticles() {
      const geometry = new THREE.SphereGeometry(0.1, 8, 8);
      const material = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true });
      const particles = new THREE.Group();

      // 创建多个粒子
      for (let i = 0; i < 16000; i++) {
        const particle = new THREE.Mesh(geometry, material);
        particle.position.set(
          (Math.random() - 0.5) * 20,  // x
          (Math.random() - 0.5) * 20,  // y
          (Math.random() - 0.5) * 20   // z
        );
        particles.add(particle);
      }

      return particles;
    }
  </script>
</body>
</html>
